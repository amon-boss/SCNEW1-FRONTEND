<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Connect - Messagerie</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background: linear-gradient(90deg, #4b6cb7, #8f94fb); color:#fff;">
    <button id="back-btn" aria-label="Retour">&larr; Retour</button>
    <h2 id="chat-title" style="margin:0;">Messagerie</h2>
    <div></div> <!-- espace pour équilibrer le header -->
  </header>

  <main style="max-width: 700px; margin: 20px auto; display:flex; flex-direction: column; height: 80vh; border: 1px solid #ccc; border-radius: 10px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
    <div id="messages" style="flex-grow:1; overflow-y:auto; padding:15px;"></div>
    <form id="message-form" style="display:flex; border-top:1px solid #ddd;">
      <input type="text" id="message-input" placeholder="Écrire un message..." autocomplete="off" required style="flex-grow:1; padding:10px; border:none; font-size: 1rem;" />
      <button type="submit" style="padding: 0 20px; background: #6d4bca; color: white; border:none; cursor:pointer; transition: background-color 0.3s;">Envoyer</button>
    </form>
  </main>

  <script src="script.js"></script>
  <script>
    // Récupérer les infos de la query string (userId et username)
    const params = new URLSearchParams(window.location.search);
    const interlocuteurId = params.get('userId');
    const interlocuteurName = params.get('username') || "Contact";

    // Afficher le nom dans le header
    document.getElementById('chat-title').textContent = `Chat avec ${interlocuteurName}`;

    // Retour page fil actualités
    document.getElementById('back-btn').addEventListener('click', () => {
      window.location.href = 'fil_actualites.html';
    });

    // Clé pour stocker les messages localement (simple, pour démo)
    const STORAGE_KEY = `chat_${interlocuteurId}`;

    // Charger les messages du localStorage
    function loadMessages() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    // Sauvegarder messages
    function saveMessages(messages) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    }

    // Afficher les messages dans le div #messages
    function renderMessages() {
      const container = document.getElementById('messages');
      const messages = loadMessages();
      container.innerHTML = '';

      messages.forEach(msg => {
        const div = document.createElement('div');
        div.classList.add('message');
        div.style.margin = '10px 0';
        div.style.padding = '8px 12px';
        div.style.borderRadius = '15px';
        div.style.maxWidth = '70%';
        div.style.wordWrap = 'break-word';
        div.style.fontSize = '1rem';

        const date = new Date(msg.timestamp);
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (msg.fromSelf) {
          div.style.background = 'linear-gradient(90deg, #4b6cb7, #8f94fb)';
          div.style.color = 'white';
          div.style.marginLeft = 'auto';
          div.innerHTML = `${msg.text} <br><small style="font-size:0.7rem; opacity:0.7;">${timeStr}</small>`;
        } else {
          div.style.background = '#eee';
          div.style.color = '#333';
          div.style.marginRight = 'auto';
          div.innerHTML = `<strong>${interlocuteurName}</strong><br>${msg.text}<br><small style="font-size:0.7rem; opacity:0.7;">${timeStr}</small>`;
        }
        container.appendChild(div);
      });

      // Scroll en bas pour voir les derniers messages
      container.scrollTop = container.scrollHeight;
    }

    // Initial affichage
    renderMessages();

    // Envoyer un message
    document.getElementById('message-form').addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;

      const messages = loadMessages();
      messages.push({
        text,
        timestamp: Date.now(),
        fromSelf: true
      });
      saveMessages(messages);
      renderMessages();
      input.value = '';

      // Ici tu peux aussi envoyer ce message à ton backend via API REST ou WebSocket
      // Pour l'instant c'est juste localStorage, donc pas un vrai chat en temps réel.
    });

    // TODO: Chargement des messages depuis backend + WebSocket pour réel chat
  </script>
</body>
</html>
